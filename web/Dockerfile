FROM node:16-alpine as build
WORKDIR /app
COPY ./web .
RUN apk add python3 make g++ && rm -rf /var/cache/apk/*
RUN CI=false yarn install

ARG PORT
ENV PORT $PORT

ARG REACT_APP_BACKEND
ENV REACT_APP_BACKEND $REACT_APP_BACKEND

ARG REACT_APP_STAT_URL
ENV REACT_APP_STAT_URL $REACT_APP_STAT_URL

ARG REACT_APP_COUNTRY_NAME
ENV REACT_APP_COUNTRY_NAME $REACT_APP_COUNTRY_NAME

ARG REACT_APP_COUNTRY_NAME
ENV REACT_APP_COUNTRY_NAME $REACT_APP_COUNTRY_NAME

ARG REACT_APP_COUNTRY_FLAG_URL
ENV REACT_APP_COUNTRY_FLAG_URL $REACT_APP_COUNTRY_FLAG_URL

ARG REACT_APP_COUNTRY_CODE
ENV REACT_APP_COUNTRY_CODE $REACT_APP_COUNTRY_CODE

ARG REACT_APP_MAPBOXGL_ACCESS_TOKEN
ENV REACT_APP_MAPBOXGL_ACCESS_TOKEN $REACT_APP_MAPBOXGL_ACCESS_TOKEN

ARG REACT_APP_MAP_TYPE
ENV REACT_APP_MAP_TYPE $REACT_APP_MAP_TYPE

ARG REACT_APP_THEME_COLOR
ENV REACT_APP_THEME_COLOR $REACT_APP_THEME_COLOR

ARG REACT_APP_THEME_COLOR_GRADIENT
ENV REACT_APP_THEME_COLOR_GRADIENT $REACT_APP_THEME_COLOR_GRADIENT

ARG REACT_APP_LOGIN_IMAGE_PNG
ENV REACT_APP_LOGIN_IMAGE_PNG $REACT_APP_LOGIN_IMAGE_PNG

ARG REACT_APP_LOGIN_IMAGE_WEBP
ENV REACT_APP_LOGIN_IMAGE_WEBP $REACT_APP_LOGIN_IMAGE_WEBP

ARG REACT_APP_COMPANY
ENV REACT_APP_COMPANY $REACT_APP_COMPANY

ARG REACT_APP_GROUP
ENV REACT_APP_GROUP $REACT_APP_GROUP

ARG REACT_APP_SYSTEM_NAME
ENV REACT_APP_SYSTEM_NAME $REACT_APP_SYSTEM_NAME

ARG REACT_APP_LOGO
ENV REACT_APP_LOGO $REACT_APP_LOGO

ARG REACT_APP_COMPANY_ENITITY
ENV REACT_APP_COMPANY_ENITITY $REACT_APP_COMPANY_ENITITY

ARG REACT_APP_COMPANY_LIMITED
ENV REACT_APP_COMPANY_LIMITED $REACT_APP_COMPANY_LIMITED

# Build the app
RUN CI=false yarn build

# production environment
FROM nginx:stable-alpine
COPY --from=build /app/build /usr/share/nginx/html
COPY ./web/nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE $PORT
CMD ["nginx", "-g", "daemon off;"]
